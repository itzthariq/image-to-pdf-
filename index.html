<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image to PDF Converter with Editing</title>
    <style>
        :root {
    --primary: #4a6fa5;
    --secondary: #166088;
    --light: #f8f9fa;
    --dark: #343a40;
    --success: #28a745;
    --danger: #dc3545;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 20px;
}

.container {
    max-width: 1000px;
    margin: 0 auto;
    background: white;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

h1 {
    color: var(--secondary);
    text-align: center;
    margin-bottom: 20px;
}

.upload-area {
    border: 2px dashed var(--primary);
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    margin-bottom: 20px;
    transition: all 0.3s;
    cursor: pointer;
}

.upload-area:hover {
    background: rgba(74, 111, 165, 0.05);
}

.upload-area.drag-over {
    background: rgba(74, 111, 165, 0.1);
    border-color: var(--secondary);
}

.preview-container {
    margin-top: 30px;
}

.image-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.image-item {
    position: relative;
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
    transition: transform 0.3s;
}

.image-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.image-preview {
    width: 100%;
    height: 150px;
    object-fit: contain;
    background: #f9f9f9;
}

.image-actions {
    display: flex;
    justify-content: space-around;
    padding: 8px;
    background: #f8f9fa;
}

.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--primary);
    font-size: 14px;
}

.action-btn:hover {
    color: var(--secondary);
}

.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: space-between;
    margin-top: 20px;
    padding: 15px 0;
    border-top: 1px solid #eee;
}

.edit-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    flex: 1 1 auto;
    text-align: center;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--secondary);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.progress-container {
    margin-top: 20px;
    display: none;
}

.progress-bar {
    height: 10px;
    background: #e9ecef;
    border-radius: 5px;
    overflow: hidden;
}

.progress {
    height: 100%;
    background: var(--success);
    width: 0%;
    transition: width 0.3s;
}

.sortable-ghost {
    opacity: 0.5;
    background: #c8ebfb;
}

/* -------------------- */
/* üì± Responsive Styling */
/* -------------------- */
@media (max-width: 768px) {
    .container {
        padding: 20px;
    }

    .upload-area {
        padding: 25px;
    }

    .image-list {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }

    .controls {
        flex-direction: column;
        align-items: stretch;
    }

    .edit-options {
        flex-direction: column;
        width: 100%;
    }

    .btn {
        width: 100%;
    }
}

@media (max-width: 480px) {
    .image-preview {
        height: 120px;
    }

    .upload-area {
        padding: 20px;
        font-size: 14px;
    }

    .action-btn {
        font-size: 12px;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <h1>Image to PDF Converter</h1>
        
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
            <h3>Drag & Drop your images here</h3>
            <p>or</p>
            <button class="btn btn-primary" id="selectFilesBtn">Select Images</button>
            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
        </div>
        
        <div class="preview-container" id="previewContainer" style="display: none;">
            <h3>Selected Images</h3>
            <p>Drag to reorder, click buttons to edit</p>
            <div class="image-list" id="imageList"></div>
            
            <div class="controls">
                <div class="edit-options">
                    <button class="btn btn-secondary" id="rotateLeftBtn">‚Ü© Rotate Left</button>
                    <button class="btn btn-secondary" id="rotateRightBtn">‚Ü™ Rotate Right</button>
                    <button class="btn btn-secondary" id="flipHorizontalBtn">‚Üî Flip Horizontal</button>
                    <button class="btn btn-secondary" id="flipVerticalBtn">‚Üï Flip Vertical</button>
                </div>
                <button class="btn btn-primary" id="generatePdfBtn">Generate PDF</button>
            </div>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress" id="progressBar"></div>
            </div>
            <div id="statusText" style="text-align: center; margin-top: 5px;">Processing...</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const previewContainer = document.getElementById('previewContainer');
            const imageList = document.getElementById('imageList');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            
            // Edit buttons
            const rotateLeftBtn = document.getElementById('rotateLeftBtn');
            const rotateRightBtn = document.getElementById('rotateRightBtn');
            const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
            const flipVerticalBtn = document.getElementById('flipVerticalBtn');
            
            let images = [];
            let currentEdits = [];
            
            // Initialize drag and drop sorting
            let sortable = new Sortable(imageList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function() {
                    // Update images array to match new order
                    const items = Array.from(imageList.children);
                    images = items.map(item => {
                        return images.find(img => img.id === item.dataset.id);
                    });
                }
            });
            
            // File selection
            document.getElementById('selectFilesBtn').addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFiles(e.target.files);
                    fileInput.value = '';
                }
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
            
            // Edit functions
            rotateLeftBtn.addEventListener('click', () => applyEdit('rotate_90'));
            rotateRightBtn.addEventListener('click', () => applyEdit('rotate_270'));
            flipHorizontalBtn.addEventListener('click', () => applyEdit('flip_horizontal'));
            flipVerticalBtn.addEventListener('click', () => applyEdit('flip_vertical'));
            
            // Generate PDF
            generatePdfBtn.addEventListener('click', generatePdf);
            
            function handleFiles(files) {
                const validFiles = Array.from(files).filter(file => 
                    file.type.startsWith('image/')
                );
                
                if (validFiles.length === 0) {
                    alert('Please select valid image files (PNG, JPG, etc.)');
                    return;
                }
                
                // Process each file
                validFiles.forEach(file => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const imgData = e.target.result;
                        const imgId = 'img-' + Math.random().toString(36).substr(2, 9);
                        
                        images.push({
                            id: imgId,
                            file: file,
                            data: imgData,
                            name: file.name,
                            edits: []
                        });
                        
                        renderPreviews();
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            function renderPreviews() {
                imageList.innerHTML = '';
                
                if (images.length === 0) {
                    previewContainer.style.display = 'none';
                    return;
                }
                
                previewContainer.style.display = 'block';
                
                images.forEach((img, index) => {
                    const imgItem = document.createElement('div');
                    imgItem.className = 'image-item';
                    imgItem.dataset.id = img.id;
                    imgItem.draggable = true;
                    
                    const imgPreview = document.createElement('img');
                    imgPreview.className = 'image-preview';
                    imgPreview.src = img.data;
                    imgPreview.alt = img.name;
                    
                    const imgActions = document.createElement('div');
                    imgActions.className = 'image-actions';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'action-btn';
                    removeBtn.innerHTML = '‚ùå Remove';
                    removeBtn.addEventListener('click', () => removeImage(img.id));
                    
                    imgActions.appendChild(removeBtn);
                    
                    imgItem.appendChild(imgPreview);
                    imgItem.appendChild(imgActions);
                    imageList.appendChild(imgItem);
                });
            }
            
            function removeImage(id) {
                images = images.filter(img => img.id !== id);
                renderPreviews();
            }
            
            function applyEdit(editType) {
                if (images.length === 0) return;
                
                // Show processing
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                statusText.textContent = 'Applying edits...';
                
                // Prepare form data
                const formData = new FormData();
                images.forEach((img, index) => {
                    formData.append('files', img.file);
                });
                formData.append('edits[]', editType);
                
                // Send to server
                fetch('/process-images', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.images) {
                        // Update images with edited versions
                        images = images.map((img, index) => {
                            if (data.images[index]) {
                                return {
                                    ...img,
                                    data: 'data:image/jpeg;base64,' + btoa(
                                        new Uint8Array(data.images[index].data)
                                        .reduce((data, byte) => data + String.fromCharCode(byte), '')
                                    ),
                                    edits: [...img.edits, editType]
                                };
                            }
                            return img;
                        });
                        
                        renderPreviews();
                        progressBar.style.width = '100%';
                        statusText.textContent = 'Edits applied successfully!';
                        
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                        }, 2000);
                    } else {
                        throw new Error(data.error || 'Edit failed');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusText.textContent = 'Error applying edits: ' + error.message;
                    progressBar.style.backgroundColor = 'var(--danger)';
                });
            }
            
            function generatePdf() {
                if (images.length === 0) {
                    alert('Please add at least one image');
                    return;
                }
                
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = 'var(--success)';
                statusText.textContent = 'Preparing PDF...';
                
                // Prepare image data with edits
                const imageData = images.map(img => ({
                    name: img.name,
                    data: img.data.split(',')[1] // Remove data URL prefix
                }));
                
                fetch('/generate-pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ images: imageData })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error); });
                    }
                    return response.blob();
                })
                .then(blob => {
                    progressBar.style.width = '100%';
                    statusText.textContent = 'PDF generated successfully!';
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'document.pdf';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Clean up
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusText.textContent = 'Error: ' + error.message;
                    progressBar.style.backgroundColor = 'var(--danger)';
                });
            }
        });
    </script>
</body>
</html>